<?php

/**
 * @file
 * Contains CommerceSBPaymentUI.
 */

/**
 * Defines a class for testing the Commerce SoftBank Payment Service UI.
 */
class CommerceSBPaymentUI extends CommerceBaseTestCase {

  /**
   * A custom site name for testing purposes.
   *
   * @var string
   */
  protected $siteName = 'SoftBank Testing';

  /**
   * Dummy commerce product.
   *
   * @var object
   */
  protected $product;

  /**
   * Admin user account for testing.
   *
   * @var object
   */
  protected $storeAdmin;

  /**
   * Customer user account for testing.
   *
   * @var object
   */
  protected $storeCustomer;

  /**
   * Order object.
   *
   * @var object
   */
  protected $order;

  /**
   * Payment method settings for the link type service.
   *
   * @var array
   */
  protected $linkTypeSettings = array(
    'mode' => 'test',
    'pay_methods' => array(
      'credit' => 'credit',
      'docomo' => 'docomo',
    ),
    'merchant_id' => 'TEST123',
    'service_id' => '001',
    'hash_key' => 't7e06iyq5opmhcf1ekw0',
    'debug' => 0,
  );

  /**
   * Example payment methods keyed by machine name.
   *
   * @var array
   */
  protected $paymentMethods = array(
    'credit' => 'Credit card payment',
    'docomo' => 'Docomo Keitai Barai',
  );

  /**
   * {@inheritdoc}
   */
  public static function getInfo() {
    return array(
      'name' => 'Commerce SoftBank Payment Service UI',
      'description' => 'Tests the payment and administrative UI for the Commerce SoftBank Payment Service module.',
      'group' => 'Commerce SoftBank Payment Service',
    );
  }

  /**
   * {@inheritdoc}
   */
  public function setUp() {
    // Get the list of commerce modules to enable.
    $modules = parent::setUpHelper('all');

    // We don't need the example payment module.
    $key = array_search('commerce_payment_example', $modules);
    if (FALSE !== $key) {
      unset($modules[$key]);
    }

    // Enable the commerce modules.
    parent::setUp($modules);

    // User creation for different operations.
    $this->storeAdmin = $this->createStoreAdmin();
    $this->storeCustomer = $this->createStoreCustomer();

    // Enable Japanese Yen and US Dollars.
    $this->enableCurrencies(array('JPY', 'USD'));

    // Create a dummy product.
    $this->product = $this->createDummyProduct('PROD-01', 'Product One', 1000, 'JPY');

    // Set the site name.
    variable_set('site_name', $this->siteName);

    // Set the default currency to Japanese Yen.
    variable_set('commerce_default_currency', 'JPY');

    // Set the default country to Japan.
    variable_set('site_default_country', 'JP');

    // Enable Commerce Smartpay.
    $success = module_enable(array('commerce_sbpayment'), TRUE);
    $this->assertTrue($success, t('Enabled the Commerce SoftBank Payment Service module.'));

    // Reset caches.
    $this->resetAll();

    // Configure the payment method settings.
    $this->configureSoftBankPaymentMethod('commerce_sbpayment_link_type', $this->linkTypeSettings);
  }

  // TODO: Test API functionality: Checksum generation, request generaton and
  // response verification.

  // TODO: Test payment method administration.

  /**
   * Test the payment on checkout process using an authenticated user.
   */
  public function testCommerceSbPaymentCheckoutProcess() {
    // Create a test order for our user and product.
    $this->createOrderAndGoToPayment($this->storeCustomer, array($this->product->product_id => 1));

    // Check the payment pane is present.
    $this->assertText(t('SoftBank Payment Service'), t('SoftBank payment service pane is present'));

    // Check the SoftBank payment options pane is present with all enabled
    // pay method options.
    foreach ($this->linkTypeSettings['pay_methods'] as $pay_method) {
      $this->assertFieldByName('commerce_payment[payment_details][softbank_pay_method]', $pay_method, t('Radio button present for @pay_method', array('@pay_method' => $this->paymentMethods[$pay_method])));
    }

    $pay_method_choice = array(
      'commerce_payment[payment_details][softbank_pay_method]' => 'credit',
    );

    // Finish checkout process. We can't really test past this point as we get
    // redirected off to SoftBank.
    $this->drupalPost(NULL, $pay_method_choice, t('Continue to next step'));
    $this->assertFieldById('edit-submit', t('Proceed to SoftBank'), t('Redirection button to SoftBank is present'));
  }

  // TODO: Test checkout process with incorrect default currencies.

  /**
   * Generate random valid information for Address information.
   */
  protected function generateAddressInformation() {
    $address_info['name_line'] = $this->randomName();
    $address_info['thoroughfare'] = $this->randomName();
    $address_info['locality'] = $this->randomName();
    $address_info['postal_code'] = rand(00000, 99999);
    $address_info['administrative_area'] = '01';

    return $address_info;
  }

  /**
   * Create a dummy order and go to checkout payment page.
   */
  protected function createOrderAndGoToPayment($user = NULL, $products = array()) {
    // Log in if we have a valid user object.
    if (!is_null($user)) {
      $this->drupalLogin($user);
    }

    // Order creation, in cart status.
    $this->order = $this->createDummyOrder(!is_null($user) ? $user->uid : 0, $products);

    // Go to checkout page.
    $this->drupalGet($this->getCommerceUrl('checkout'));

    // Check if the page resolves and if the default panes are present.
    $this->assertResponse(200, t('Store customer user is able to access the checkout page'));
    $this->assertTitle(t('Checkout | @site_name', array('@site_name' => $this->siteName)), t('Checkout page successfully loaded'));

    // Generate random information, as city, postal code, etc.
    $address_info = $this->generateAddressInformation();

    // Fill in the billing address information.
    $billing_pane = $this->xpath("//select[starts-with(@name, 'customer_profile_billing[commerce_customer_address]')]");
    $this->drupalPostAJAX(NULL, array((string) $billing_pane[0]['name'] => 'JP'), (string) $billing_pane[0]['name']);

    // Check if the country has been selected correctly, this uses XPath as the
    // ajax call replaces the element and the id may change.
    $this->assertFieldByXPath("//select[starts-with(@id, 'edit-customer-profile-billing-commerce-customer-address')]//option[@selected='selected']", 'JP', t('Country selected'));

    // Fill in the required information for billing pane, with a random State.
    $info = array(
      'customer_profile_billing[commerce_customer_address][und][0][name_line]' => $address_info['name_line'],
      'customer_profile_billing[commerce_customer_address][und][0][thoroughfare]' => $address_info['thoroughfare'],
      'customer_profile_billing[commerce_customer_address][und][0][locality]' => $address_info['locality'],
      'customer_profile_billing[commerce_customer_address][und][0][administrative_area]' => $address_info['administrative_area'],
      'customer_profile_billing[commerce_customer_address][und][0][postal_code]' => $address_info['postal_code'],
    );
    $this->drupalPost(NULL, $info, t('Continue to next step'));

    // Check for default panes and information in this checkout phase.
    $this->assertTitle(t('Review order | @site_name', array('@site_name' => $this->siteName)), t('Review order page successfully loaded'));
  }

  /**
   * Configure the payment method rule for SoftBank.
   *
   * @param string $payment_method_id
   *   The commerce payment method ID.
   * @param array $settings
   *   Settings for the payment method.
   */
  protected function configureSoftBankPaymentMethod($payment_method_id, $settings = array()) {
    // Load the payment method rule config.
    $rule_config = rules_config_load("commerce_payment_{$payment_method_id}");

    if (!empty($rule_config)) {
      foreach ($rule_config->actions() as $action) {
        if (!empty($action->settings['payment_method']) && "commerce_payment_enable_{$payment_method_id}" === $action->getElementName()) {
          // During initialization of action the "payment_method" key will
          // contain the method ID.
          if (!is_array($action->settings['payment_method'])) {
            $action->settings['payment_method'] = array();
          }

          // Ensure that we have an array in "settings" key.
          $action->settings['payment_method'] += array('settings' => array());

          // Set the payment method ID.
          $action->settings['payment_method']['method_id'] = $payment_method_id;

          // Override any supplied payment method settings.
          $action->settings['payment_method']['settings'] = array_merge($action->settings['payment_method']['settings'], $settings);
        }
      }

      $rule_config->save();
    }
  }

}
